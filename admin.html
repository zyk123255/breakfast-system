<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>朴树居 早餐后台</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:"Microsoft YaHei",sans-serif;margin:0;padding:0;background:#f7f7f7;}
header {background:#444;color:white;padding:10px;text-align:center;font-size:20px;}
.container {max-width:1000px;margin:20px auto;background:white;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
table {width:100%;border-collapse:collapse;margin-top:10px;}
th,td {border:1px solid #ddd;padding:8px;text-align:center;}
th {background:#f0f0f0;}
button {background:#444;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;}
button:hover {background:#222;}
/* 加大表格输入框 */
table input {
  width: 90%;
  padding: 6px;
  font-size: 16px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: center;
}
</style>
</head>
<body>
<header>朴树居 早餐后台</header>
<div class="container">
  <label>选择日期：</label>
  <select id="viewDate" onchange="loadOrders()"></select>
  <button onclick="clearToday()">清空选中日期数据</button>
  <button onclick="loadOrders()">刷新数据</button>

  <table>
    <thead>
      <tr>
        <th>房间号</th>
        <th>人数</th>
        <th>明细</th>
        <th>就餐时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="orderTable"></tbody>
  </table>

  <h3>早餐总计：</h3>
  <p>总人数：<span id="totalGuests">0</span></p>
  <ul id="summaryList"></ul>
</div>

<script>
function formatDate(d){ return d.toISOString().slice(0,10); }

function initViewDate(){
  const select=document.getElementById('viewDate');
  const today=new Date();
  const tomorrow=new Date(); tomorrow.setDate(today.getDate()+1);
  const optionToday=document.createElement('option');
  optionToday.value=formatDate(today); optionToday.textContent=formatDate(today);
  const optionTomorrow=document.createElement('option');
  optionTomorrow.value=formatDate(tomorrow); optionTomorrow.textContent=formatDate(tomorrow);
  select.appendChild(optionToday); select.appendChild(optionTomorrow);
}

initViewDate();

function loadOrders(){
  const selectedDate=document.getElementById('viewDate').value;
  let data=JSON.parse(localStorage.getItem('orders')||'[]');
  data=data.filter(o=>o.date===selectedDate);

  const tbody=document.getElementById('orderTable');
  tbody.innerHTML='';
  const summary={}; let totalGuests=0;

  data.forEach((order,index)=>{
    totalGuests+=parseInt(order.count);
    order.items.forEach(it=>summary[it.name]=(summary[it.name]||0)+it.qty);

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input value="${order.room}" onchange="updateOrder(${index},'room',this.value)"></td>
      <td><input type="number" min="1" value="${order.count}" onchange="updateOrder(${index},'count',this.value)"></td>
      <td><input value="${order.details}" onchange="updateOrder(${index},'details',this.value)"></td>
      <td><input value="${order.time}" onchange="updateOrder(${index},'time',this.value)"></td>
      <td><button onclick="deleteOrder(${index})">删除</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalGuests').textContent=totalGuests;
  const summaryList=document.getElementById('summaryList');
  summaryList.innerHTML='';
  for(const k in summary){ const li=document.createElement('li'); li.textContent=`${k}：${summary[k]}`; summaryList.appendChild(li);}
}

function updateOrder(index,key,value){
  const selectedDate=document.getElementById('viewDate').value;
  let data=JSON.parse(localStorage.getItem('orders')||'[]');
  const filteredIndexes=data.map((o,i)=>o.date===selectedDate?i:-1).filter(i=>i!==-1);
  const realIndex=filteredIndexes[index];
  if(realIndex!==undefined){ data[realIndex][key]=value; localStorage.setItem('orders',JSON.stringify(data)); loadOrders(); }
}

function deleteOrder(index){
  const selectedDate=document.getElementById('viewDate').value;
  let data=JSON.parse(localStorage.getItem('orders')||'[]');
  const filteredIndexes=data.map((o,i)=>o.date===selectedDate?i:-1).filter(i=>i!==-1);
  const realIndex=filteredIndexes[index];
  if(realIndex!==undefined){ if(confirm('确定删除这条订单吗？')){ data.splice(realIndex,1); localStorage.setItem('orders',JSON.stringify(data)); loadOrders(); } }
}

function clearToday(){
  const selectedDate=document.getElementById('viewDate').value;
  if(confirm('确定清空选中日期的所有数据吗？')){
    let data=JSON.parse(localStorage.getItem('orders')||'[]');
    data=data.filter(o=>o.date!==selectedDate);
    localStorage.setItem('orders',JSON.stringify(data));
    loadOrders();
  }
}

// 自动清理非今天/明天的数据
(function cleanupOldData(){
  const today=formatDate(new Date());
  const tomorrow=formatDate(new Date(new Date().setDate(new Date().getDate()+1)));
  let data=JSON.parse(localStorage.getItem('orders')||'[]');
  data=data.filter(o=>o.date===today || o.date===tomorrow);
  localStorage.setItem('orders',JSON.stringify(data));
})();

loadOrders();
</script>
</body>
</html>
